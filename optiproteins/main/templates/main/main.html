<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche Protéine</title>

    <script
      type="text/javascript"
      src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js">
    </script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      form {
          margin-bottom: 20px;
          border: 1px solid #ddd;
          padding: 15px;
          border-radius: 8px;
          background-color: #f9f9f9;
      }

      .form-section {
          margin-bottom: 15px;
      }

      .form-section h3 {
          margin-bottom: 10px;
      }

      label {
          display: block;
          margin-bottom: 5px;
          font-weight: bold;
      }

      input[type="text"], button {
          margin-bottom: 10px;
          padding: 8px;
          width: 100%;
          box-sizing: border-box;
      }

      button {
          background-color: #007bff;
          color: white;
          border: none;
          cursor: pointer;
      }

      button:hover {
          background-color: #0056b3;
      }

      .error {
          color: red;
          font-weight: bold;
      }

      .success {
          color: green;
      }
      #network {
          width: 800px;
          height: 500px;
          border: 1px solid lightgray;
          margin-top: 20px;
      }
    </style>
    
</head>
<body>
    <h1>Rechercher une protéine</h1>
    
    <!-- Formulaire de recherche -->
    <form method="post" action="">
      {% csrf_token %}
      
      <div class="form-section">
          <h3>Champs de recherche</h3>
          <label for="id">Entrez un identifiant :</label>
          <input 
              type="text" 
              id="id" 
              name="id" 
              value="{{ request.POST.id|default:'' }}" 
          ><br>
          
          <label for="name">Entrez un nom :</label>
          <input 
              type="text" 
              id="name" 
              name="name" 
              value="{{ request.POST.name|default:'' }}" 
          ><br>

          <label for="description">Entrez une description :</label>
          <input 
              type="text" 
              id="description" 
              name="description" 
              value="{{ request.POST.description|default:'' }}" 
          ><br>

          <p><em>Au moins un de ces champs doit être rempli.</em></p>
      </div>
      
      <div class="form-section">
          <h3>Paramètres pour le graphe</h3>
          <label for="min_jacc">Valeur minimale de similarité Jaccard (entre 0 et 1) :</label>
          <input 
              type="text" 
              id="min_jacc" 
              name="min_jacc" 
              value="{{ request.POST.min_jacc|default:'' }}" 
          ><br>
          <p><em>Remplissez ce champ uniquement si vous voulez afficher le graphe.</em></p>
      </div>

      <div class="form-section">
          <button type="submit" name="action" value="rechercher">Rechercher</button>
          <button type="submit" name="action" value="afficher_graphe">Afficher le graphe</button>
      </div>
    </form>
    
    <!-- Message d'erreur -->
    {% if erreur %}
        <p style="color: red;">{{ erreur }}</p>
    {% endif %}
    
    <!-- Résultat de la recherche -->
    {% if proteine and not similarities%}
        <h2>Informations :</h2>
        <p><strong>Entry :</strong> {{ proteine.Entry }}</p>
        <p><strong>Entry Name :</strong> {{ proteine.Entry_Name }}</p>
        <p><strong>Protein names :</strong> {{ proteine.Protein_names }}</p>
        <p><strong>Gene Names :</strong> {{ proteine.Gene_Names }}</p>
        <p><strong>Organism :</strong> {{ proteine.Organism }}</p>
        <p><strong>Sequence :</strong> {{ proteine.Sequence }}</p>
        <p><strong>EC number :</strong> {{ proteine.EC_number }}</p>
        <p><strong>InterPro :</strong> {{ proteine.InterPro }}</p>
    
    {% endif %}



    {% if similarities %}
    <h2>Similarités Jaccard (Neo4j) (min_jacc = {{ min_jacc }})</h2>
    <div id="network"></div>

    <script>
      let nodes = [];
      let edges = [];// Construire un tableau JavaScript des similarités

      // Définir l'ID central à partir de 'Entry_Name' pour éviter les collisions
      let centralId = "{{ proteine.Entry_Name|escapejs }}";

      // Ajouter le nœud central (en rouge)
      nodes.push({
        id: centralId,
        label: centralId,
        color: 'red'
      });

      let similarities = [
          {% for item in similarities %}
              {
                  "entry": "{{ item.protein.entry|escapejs }}",
                  "entryName": "{{ item.protein.entryName|default:item.protein.entry|escapejs }}",
                  "similarity": {{ item.similarity }}
              },
          {% endfor %}
      ];

      // Parcourir le tableau des similarités pour ajouter les voisins
      similarities.forEach(function(item) {
          let neighborId = item.entryName || item.entry;  // Utiliser 'entryName' si disponible
          let neighborName = item.entryName || item.entry;
          let similarity = item.similarity.toFixed(2);    // Arrondir à 2 décimales

          // Ajouter le nœud voisin
          nodes.push({
              id: neighborId,
              label: neighborName
          });

          // Ajouter l'arête entre le nœud central et le voisin
          edges.push({
              from: centralId,
              to: neighborId,
              label: similarity
          });
      });

      console.log("DEBUG - nodes:", nodes);
      console.log("DEBUG - edges:", edges);

      // Initialiser le graphe Vis.js
      let container = document.getElementById('network');
      let data = {
        nodes: new vis.DataSet(nodes),
        edges: new vis.DataSet(edges)
      };
      let options = {
        edges: {
          font: { align: 'horizontal' },
          arrows: { to: { enabled: true } }
        },
        physics: {
          enabled: true
        },
      };

      let network = new vis.Network(container, data, options);
    </script>
    {% endif %}
</body>
</html>
