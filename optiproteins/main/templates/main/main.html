<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche Protéine</title>

    <script
      type="text/javascript"
      src="https://unpkg.com/vis-network@9.1.2/standalone/umd/vis-network.min.js">
    </script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      form {
          margin-bottom: 20px;
          border: 1px solid #ddd;
          padding: 15px;
          border-radius: 8px;
          background-color: #f9f9f9;
      }

      .form-section {
          margin-bottom: 15px;
      }

      .form-section h3 {
          margin-bottom: 10px;
      }

      label {
          display: block;
          margin-bottom: 5px;
          font-weight: bold;
      }

      input[type="text"], button {
          margin-bottom: 10px;
          padding: 8px;
          width: 100%;
          box-sizing: border-box;
      }

      button {
          background-color: #007bff;
          color: white;
          border: none;
          cursor: pointer;
      }

      button:hover {
          background-color: #0056b3;
      }

      .error {
          color: red;
          font-weight: bold;
      }

      .success {
          color: green;
      }
      #network {
          width: 800px;
          height: 500px;
          border: 1px solid lightgray;
          margin-top: 20px;
      }
    </style>
    
</head>
<body>
    <h1>Rechercher une protéine</h1>
    
    <!-- Formulaire de recherche -->
    <form method="post" action="">
      {% csrf_token %}
      
      <div class="form-section">
          <h3>Champs de recherche</h3>
          <label for="id">Entrez un identifiant :</label>
          <input 
              type="text" 
              id="id" 
              name="id" 
              value="{{ request.POST.id|default:'' }}" 
          ><br>
          
          <label for="name">Entrez un nom :</label>
          <input 
              type="text" 
              id="name" 
              name="name" 
              value="{{ request.POST.name|default:'' }}" 
          ><br>

          <label for="description">Entrez une description :</label>
          <input 
              type="text" 
              id="description" 
              name="description" 
              value="{{ request.POST.description|default:'' }}" 
          ><br>

          <p><em>Au moins un de ces champs doit être rempli.</em></p>
      </div>
      
      <div class="form-section">
          <h3>Paramètres pour le graphe</h3>
          <label for="min_jacc">Valeur minimale de similarité Jaccard (entre 0 et 1) :</label>
          <input 
              type="text" 
              id="min_jacc" 
              name="min_jacc" 
              value="{{ request.POST.min_jacc|default:'' }}" 
          ><br>
          <label for="two_levels">
            <input 
                type="checkbox" 
                id="two_levels" 
                name="two_levels" 
                {% if request.POST.two_levels %}checked{% endif %}
            >
            2 niveaux de profondeurs
        </label><br>
          <p><em>Remplissez ce champ uniquement si vous voulez afficher le graphe.</em></p>
      </div>

      <div class="form-section">
          <button type="submit" name="action" value="rechercher">Rechercher</button>
          <button type="submit" name="action" value="afficher_graphe">Afficher le graphe</button>
      </div>
    </form>
    
    <!-- Message d'erreur -->
    {% if erreur %}
        <p style="color: red;">{{ erreur }}</p>
    {% endif %}
    
    <!-- Résultat de la recherche -->
    {% if proteine and not nodes_json%}
        <h2>Informations :</h2>
        <p><strong>Entry :</strong> {{ proteine.Entry }}</p>
        <p><strong>Entry Name :</strong> {{ proteine.Entry_Name }}</p>
        <p><strong>Protein names :</strong> {{ proteine.Protein_names }}</p>
        <p><strong>Gene Names :</strong> {{ proteine.Gene_Names }}</p>
        <p><strong>Organism :</strong> {{ proteine.Organism }}</p>
        <p><strong>Sequence :</strong> {{ proteine.Sequence }}</p>
        <p><strong>EC number :</strong> {{ proteine.EC_number }}</p>
        <p><strong>InterPro :</strong> {{ proteine.InterPro }}</p>
    
    {% endif %}



    <!-- Graphe des Similarités -->
    {% if nodes_json and edges_json %}
    <h2>Similarités Jaccard (Neo4j) (min_jacc = {{ min_jacc }})</h2>
    <div id="network"></div>

    <script>
      // Récupérer les données JSON passées depuis le backend
      let nodes = {{ nodes_json|safe }};
      let edges = {{ edges_json|safe }};

      // Définir l'ID central pour le styliser
      let centralId = "{{ proteine.Entry_Name|escapejs }}";

      // Styliser le nœud central en rouge
      nodes = nodes.map(n => {
          if (n.id === centralId){
              return {...n, color: 'red'};
          }
          return n;
      });

      // Ajouter des labels aux arêtes
      edges = edges.map(e => ({
          from: e.from,
          to: e.to,
          label: e.similarity.toFixed(2)
      }));

      // Initialiser le graphe Vis.js
      let container = document.getElementById('network');
      let data = {
        nodes: new vis.DataSet(nodes),
        edges: new vis.DataSet(edges)
      };
      let options = {
        edges: {
          font: { align: 'horizontal' },
          arrows: { to: { enabled: true } },
          labelHighlightBold: true,
          smooth: {
            type: 'cubicBezier',
            forceDirection: 'horizontal',
            roundness: 0.4
          }
        },
        nodes: {
          shape: 'dot',
          size: 16,
          font: {
            size: 14,
            color: '#00000'
          },
          borderWidth: 2
        },
        physics: {
          enabled: true,
          stabilization: {
            iterations: 200
          }
        },
        layout: {
          improvedLayout: true
        },
        interaction: {
          hover: true,
          tooltipDelay: 200
        }
      };

      let network = new vis.Network(container, data, options);

      // Ajouter des tooltips pour les nœuds
      network.on("hoverNode", function (params) {
          let node = nodes.find(n => n.id === params.node);
          if (node) {
              let tooltip = `<strong>${node.label}</strong>`;
              network.body.container.title = tooltip;
          }
      });

      network.on("blurNode", function (params) {
          network.body.container.title = "";
      });
    </script>
    {% endif %}

    <!-- Propagation des EC Numbers -->
    {% if ec_propagation %}
        <h2>Propagation des EC Numbers</h2>
        <table>
            <thead>
                <tr>
                    <th>EC Number</th>
                    <th>Probabilité</th>
                </tr>
            </thead>
            <tbody>
                {% for ec in ec_propagation %}
                    <tr>
                        <td>{{ ec.ec_number }}</td>
                        <td>{{ ec.probability|floatformat:2 }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    {% if not ec_propagation and edges_json %}
        <h2>Pas d'EC numbers à propager</h2>
    {% endif %}

</body>
</html>
